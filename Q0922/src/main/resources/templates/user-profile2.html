<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§ˆì´í˜ì´ì§€ - Memory Treasures</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .avatar-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            font-size: 2rem;
        }
        .loading-spinner {
            min-height: 200px;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body class="bg-light">
	    <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
        <div class="container">
            <a class="navbar-brand" href="/">ğŸª Memory Treasures</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">í™ˆ</a>
                <a class="nav-link" href="/products">ìƒí’ˆ</a>
                <a class="nav-link" href="/cart">ì¥ë°”êµ¬ë‹ˆ</a>
                <span class="navbar-text me-3" id="username-display">ë¡œë”©ì¤‘...</span>
                <button id="logout-btn" class="btn btn-outline-light btn-sm">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
    </nav>

    <!-- ë¡œë”© ìŠ¤í”¼ë„ˆ -->
    <div class="container" id="loading-container">
        <div class="text-center loading-spinner d-flex align-items-center justify-content-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">ë¡œë”©ì¤‘...</span>
            </div>
            <span class="ms-3">í”„ë¡œí•„ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
        </div>
    </div>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <div class="container d-none" id="main-content">
        <div class="row">
            <!-- ì‚¬ì´ë“œë°” -->
            <div class="col-md-3">
                <div class="card shadow-sm">
                    <div class="card-body text-center">
                        <!-- í”„ë¡œí•„ ì •ë³´ -->
                        <div class="mb-3">
                            <div class="avatar-circle bg-primary text-white d-inline-flex align-items-center justify-content-center" id="user-avatar">
                                ğŸ‘¤
                            </div>
                        </div>
                        <h5 id="user-nickname">ì‚¬ìš©ìëª…</h5>
                        <p class="text-muted small" id="user-character-desc">ìºë¦­í„° ì„¤ëª…</p>
                        <span class="badge bg-success" id="user-level">ë ˆë²¨ 5</span>
                    </div>
                </div>

                <!-- í†µê³„ -->
                <div class="card shadow-sm mt-3">
                    <div class="card-body">
                        <h6 class="card-title">ğŸ“Š ë‚˜ì˜ í†µê³„</h6>
                        <div class="d-flex justify-content-between mb-2">
                            <span>êµ¬ë§¤ ê¸°ì–µ:</span>
                            <strong id="total-purchases">0ê°œ</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>ì ë¦½ í¬ì¸íŠ¸:</span>
                            <strong id="total-points">0P</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>ê°€ì…ì¼:</span>
                            <strong id="join-date">-</strong>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ë©”ì¸ ì½˜í…ì¸  -->
            <div class="col-md-9">
                <!-- í”„ë¡œí•„ ìˆ˜ì • -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">ğŸ‘¤ í”„ë¡œí•„ ì •ë³´</h5>
                    </div>
                    <div class="card-body">
                        <form id="profile-update-form">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">ì•„ì´ë””</label>
                                        <input type="text" class="form-control" id="profile-username" readonly>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="profile-nickname" class="form-label">ë‹‰ë„¤ì„</label>
                                        <input type="text" class="form-control" id="profile-nickname">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="profile-email" class="form-label">ì´ë©”ì¼</label>
                                        <input type="email" class="form-control" id="profile-email">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">ìºë¦­í„°</label>
                                        <input type="text" class="form-control" id="profile-character" readonly>
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">ì •ë³´ ìˆ˜ì •</button>
                        </form>
                    </div>
                </div>

                <!-- ì£¼ë¬¸ ë‚´ì—­ -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">ğŸ“¦ ìµœê·¼ ì£¼ë¬¸ ë‚´ì—­</h5>
                    </div>
                    <div class="card-body" id="orders-container">
                        <div class="text-center">
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                            <span class="ms-2">ì£¼ë¬¸ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
                        </div>
                    </div>
                </div>

                <!-- í¬ì¸íŠ¸ ë‚´ì—­ -->
                <div class="card shadow-sm">
                    <div class="card-header">
                        <h5 class="mb-0">ğŸ’° í¬ì¸íŠ¸ ë‚´ì—­</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span>í˜„ì¬ ë³´ìœ  í¬ì¸íŠ¸</span>
                            <h4 class="text-primary" id="current-points">0P</h4>
                        </div>
                        <div id="point-history-container">
                            <div class="text-center">
                                <div class="spinner-border spinner-border-sm" role="status"></div>
                                <span class="ms-2">í¬ì¸íŠ¸ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ì—ëŸ¬ ë©”ì‹œì§€ -->
    <div class="container d-none" id="error-container">
        <div class="alert alert-danger" role="alert">
            <h4 class="alert-heading">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</h4>
            <p id="error-message">í”„ë¡œí•„ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.</p>
            <hr>
            <div class="d-flex justify-content-center">
                <a href="/login" class="btn btn-primary">ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™</a>
            </div>
        </div>
    </div>

   <script>
        // JWT í† í° ê´€ë¦¬
        class TokenManager {
            static getAccessToken() {
                return localStorage.getItem('accessToken');
            }
            
            static getRefreshToken() {
                return localStorage.getItem('refreshToken');
            }
            
            static setTokens(accessToken, refreshToken) {
                localStorage.setItem('accessToken', accessToken);
                if (refreshToken) {
                    localStorage.setItem('refreshToken', refreshToken);
                }
            }
            
            static clearTokens() {
                localStorage.removeItem('accessToken');
                localStorage.removeItem('refreshToken');
            }
            
            static isLoggedIn() {
                return !!this.getAccessToken();
            }
        }

        // API í˜¸ì¶œ í•¨ìˆ˜
        async function apiCall(url, options = {}) {
            const token = TokenManager.getAccessToken();
            
            if (!token) {
                throw new Error('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            }

            const defaultOptions = {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            };

            const response = await fetch(url, { ...defaultOptions, ...options });

            if (response.status === 401) {
                // í† í° ë§Œë£Œ ì‹œ ë¦¬í”„ë ˆì‹œ ì‹œë„
                const refreshed = await refreshToken();
                if (!refreshed) {
                    TokenManager.clearTokens();
                    window.location.href = '/login?expired=true';
                    return;
                }
                
                // ì¬ì‹œë„
                const newToken = TokenManager.getAccessToken();
                const retryResponse = await fetch(url, {
                    ...defaultOptions,
                    ...options,
                    headers: {
                        ...defaultOptions.headers,
                        'Authorization': `Bearer ${newToken}`,
                        ...options.headers
                    }
                });
                
                if (!retryResponse.ok) {
                    throw new Error(`API í˜¸ì¶œ ì‹¤íŒ¨: ${retryResponse.status}`);
                }
                
                return retryResponse.json();
            }

            if (!response.ok) {
                throw new Error(`API í˜¸ì¶œ ì‹¤íŒ¨: ${response.status}`);
            }

            return response.json();
        }

        // í† í° ë¦¬í”„ë ˆì‹œ
        async function refreshToken() {
            const refreshToken = TokenManager.getRefreshToken();
            if (!refreshToken) return false;

            try {
                const response = await fetch('/api/auth/refresh', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ refreshToken })
                });

                if (response.ok) {
                    const data = await response.json();
                    TokenManager.setTokens(data.accessToken, data.refreshToken);
                    return true;
                }
                return false;
            } catch (error) {
                console.error('í† í° ë¦¬í”„ë ˆì‹œ ì‹¤íŒ¨:', error);
                return false;
            }
        }

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('ko-KR');
        }

        function formatDateTime(dateString) {
            return new Date(dateString).toLocaleString('ko-KR');
        }

        function formatNumber(number) {
            return new Intl.NumberFormat('ko-KR').format(number);
        }

        function getStatusBadgeClass(status) {
            const statusClasses = {
                'COMPLETED': 'bg-success',
                'SHIPPING': 'bg-warning text-dark',
                'PROCESSING': 'bg-info',
                'CANCELLED': 'bg-danger',
                'PENDING': 'bg-secondary'
            };
            return statusClasses[status] || 'bg-secondary';
        }

        // í™”ë©´ ìƒíƒœ ê´€ë¦¬
        function showLoading() {
            document.getElementById('loading-container').classList.remove('d-none');
            document.getElementById('main-content').classList.add('d-none');
            document.getElementById('error-container').classList.add('d-none');
        }

        function showContent() {
            document.getElementById('loading-container').classList.add('d-none');
            document.getElementById('main-content').classList.remove('d-none');
            document.getElementById('main-content').classList.add('fade-in');
            document.getElementById('error-container').classList.add('d-none');
        }

        function showError(message = 'í”„ë¡œí•„ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.') {
            document.getElementById('loading-container').classList.add('d-none');
            document.getElementById('main-content').classList.add('d-none');
            document.getElementById('error-container').classList.remove('d-none');
            document.getElementById('error-message').textContent = message;
        }

        // ì‚¬ìš©ì í”„ë¡œí•„ ì •ë³´ ë¡œë“œ ë° ë Œë”ë§
        async function loadUserProfile() {
            try {
                const profileData = await apiCall('/api/auth/profile');
                
                // ë„¤ë¹„ê²Œì´ì…˜ ì‚¬ìš©ìëª…
                document.getElementById('username-display').textContent = profileData.nickname;
                
                // ì‚¬ì´ë“œë°” í”„ë¡œí•„
                const avatar = profileData.characterType?.avatar || 'ğŸ‘¤';
                document.getElementById('user-avatar').textContent = avatar;
                document.getElementById('user-nickname').textContent = profileData.nickname;
                document.getElementById('user-character-desc').textContent = profileData.characterType?.description || '';
                document.getElementById('user-level').textContent = `ë ˆë²¨ ${profileData.level || 5}`;
                
                // í”„ë¡œí•„ í¼
                document.getElementById('profile-username').value = profileData.username;
                document.getElementById('profile-nickname').value = profileData.nickname;
                document.getElementById('profile-email').value = profileData.email || '';
                document.getElementById('profile-character').value = profileData.characterType?.displayName || '';
                
                // ê°€ì…ì¼
                document.getElementById('join-date').textContent = formatDate(profileData.createdAt);
                
                return profileData;
            } catch (error) {
                console.error('í”„ë¡œí•„ ë¡œë“œ ì‹¤íŒ¨:', error);
                throw error;
            }
        }

        // ì‚¬ìš©ì í†µê³„ ë¡œë“œ
        async function loadUserStats() {
            try {
                const statsData = await apiCall('/api/profile/stats');
                
                document.getElementById('total-purchases').textContent = `${statsData.totalPurchases}ê°œ`;
                document.getElementById('total-points').textContent = `${formatNumber(statsData.totalPoints)}P`;
                document.getElementById('current-points').textContent = `${formatNumber(statsData.totalPoints)}P`;
                
                return statsData;
            } catch (error) {
                console.error('í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', error);
                // í†µê³„ëŠ” í•„ìˆ˜ê°€ ì•„ë‹ˆë¯€ë¡œ ê¸°ë³¸ê°’ ì„¤ì •
                document.getElementById('total-purchases').textContent = '0ê°œ';
                document.getElementById('total-points').textContent = '0P';
                document.getElementById('current-points').textContent = '0P';
            }
        }

        // ì£¼ë¬¸ ë‚´ì—­ ë¡œë“œ ë° ë Œë”ë§
        async function loadRecentOrders() {
            try {
                const ordersData = await apiCall('/api/profile/orders');
                const container = document.getElementById('orders-container');
                
                if (!ordersData || ordersData.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-muted py-4">
                            <p>ì•„ì§ ì£¼ë¬¸í•œ ê¸°ì–µì´ ì—†ì–´ìš”!</p>
                            <a href="/products" class="btn btn-primary">ê¸°ì–µ êµ¬ê²½í•˜ëŸ¬ ê°€ê¸°</a>
                        </div>
                    `;
                    return;
                }

                const ordersHtml = ordersData.map(order => `
                    <div class="border-bottom pb-3 mb-3">
                        <div class="d-flex justify-content-between">
                            <div>
                                <strong>ì£¼ë¬¸ë²ˆí˜¸:</strong> ${order.orderNumber}<br>
                                <strong>ì£¼ë¬¸ì¼:</strong> ${formatDateTime(order.createdAt)}
                            </div>
                            <div class="text-end">
                                <span class="badge ${getStatusBadgeClass(order.status)}">${order.statusDescription || order.status}</span><br>
                                <strong>${formatNumber(order.totalAmount)}ì›</strong>
                            </div>
                        </div>
                        <div class="mt-2">
                            ${order.orderItems ? order.orderItems.map(item => 
                                `<div class="small text-muted">â€¢ ${item.productName} (${item.quantity}ê°œ)</div>`
                            ).join('') : ''}
                        </div>
                    </div>
                `).join('');

                container.innerHTML = ordersHtml + `
                    <div class="text-center">
                        <a href="/profile/orders" class="btn btn-outline-primary">ì „ì²´ ì£¼ë¬¸ ë³´ê¸°</a>
                    </div>
                `;
            } catch (error) {
                console.error('ì£¼ë¬¸ ë‚´ì—­ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('orders-container').innerHTML = `
                    <div class="alert alert-warning">
                        ì£¼ë¬¸ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
                    </div>
                `;
            }
        }

        // í¬ì¸íŠ¸ ë‚´ì—­ ë¡œë“œ ë° ë Œë”ë§
        async function loadPointHistory() {
            try {
                const pointData = await apiCall('/api/profile/points');
                const container = document.getElementById('point-history-container');
                
                if (!pointData || pointData.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-muted">
                            í¬ì¸íŠ¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.
                        </div>
                    `;
                    return;
                }

                const pointsHtml = pointData.map(point => `
                    <div class="d-flex justify-content-between py-2">
                        <div>
                            <span>${point.description}</span><br>
                            <small class="text-muted">${new Date(point.createdAt).toLocaleString('ko-KR', {
                                month: '2-digit', 
                                day: '2-digit', 
                                hour: '2-digit', 
                                minute: '2-digit'
                            })}</small>
                        </div>
                        <span class="fw-bold ${point.amount > 0 ? 'text-success' : 'text-danger'}">
                            ${point.amount > 0 ? '+' : ''}${formatNumber(point.amount)}P
                        </span>
                    </div>
                `).join('');

                container.innerHTML = pointsHtml;
            } catch (error) {
                console.error('í¬ì¸íŠ¸ ë‚´ì—­ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('point-history-container').innerHTML = `
                    <div class="alert alert-warning">
                        í¬ì¸íŠ¸ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
                    </div>
                `;
            }
        }

        // í”„ë¡œí•„ ì—…ë°ì´íŠ¸
        async function updateProfile(formData) {
            try {
                const result = await apiCall('/api/profile/update', {
                    method: 'PUT',
                    body: JSON.stringify(formData)
                });
                
                return result;
            } catch (error) {
                console.error('í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
                throw error;
            }
        }

        // ì´ˆê¸°í™” í•¨ìˆ˜
        async function initializePage() {
            // ë¡œê·¸ì¸ ì²´í¬
            if (!TokenManager.isLoggedIn()) {
                window.location.href = '/login';
                return;
            }

            showLoading();

            try {
                // ë³‘ë ¬ë¡œ ë°ì´í„° ë¡œë“œ
                await Promise.all([
                    loadUserProfile(),
                    loadUserStats(),
                    loadRecentOrders(),
                    loadPointHistory()
                ]);
                
                showContent();
            } catch (error) {
                console.error('í˜ì´ì§€ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                showError(error.message || 'í˜ì´ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë“¤
        document.addEventListener('DOMContentLoaded', function() {
            // í˜ì´ì§€ ì´ˆê¸°í™”
            initializePage();

            // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼
            document.getElementById('logout-btn').addEventListener('click', function() {
                TokenManager.clearTokens();
                window.location.href = '/login?logout=true';
            });

            // í”„ë¡œí•„ ì—…ë°ì´íŠ¸ í¼
            document.getElementById('profile-update-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = {
                    nickname: document.getElementById('profile-nickname').value,
                    email: document.getElementById('profile-email').value
                };

                const submitBtn = e.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                
                try {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>ìˆ˜ì •ì¤‘...';
                    
                    await updateProfile(formData);
                    
                    // ì„±ê³µ ë©”ì‹œì§€
                    const alert = document.createElement('div');
                    alert.className = 'alert alert-success alert-dismissible fade show mt-3';
                    alert.innerHTML = `
                        í”„ë¡œí•„ì´ ì„±ê³µì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    e.target.appendChild(alert);
                    
                    // ì‚¬ì´ë“œë°” ë‹‰ë„¤ì„ë„ ì—…ë°ì´íŠ¸
                    document.getElementById('user-nickname').textContent = formData.nickname;
                    document.getElementById('username-display').textContent = formData.nickname;
                    
                    // 3ì´ˆ í›„ ì•Œë¦¼ ìë™ ì œê±°
                    setTimeout(() => {
                        if (alert.parentNode) {
                            alert.remove();
                        }
                    }, 3000);
                    
                } catch (error) {
                    // ì—ëŸ¬ ë©”ì‹œì§€
                    const alert = document.createElement('div');
                    alert.className = 'alert alert-danger alert-dismissible fade show mt-3';
                    alert.innerHTML = `
                        í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    e.target.appendChild(alert);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                }
            });
        });

        // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ì‹œ í† í° í™•ì¸
        window.addEventListener('beforeunload', function() {
            if (!TokenManager.isLoggedIn()) {
                // í† í°ì´ ì—†ìœ¼ë©´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì˜ˆì•½
                setTimeout(() => {
                    window.location.href = '/login';
                }, 100);
            }
        });
    </script>

    <!-- Bootstrap JS (ì•Œë¦¼ ê¸°ëŠ¥ìš©) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>